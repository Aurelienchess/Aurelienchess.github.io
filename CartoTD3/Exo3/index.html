<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TD3 : Terre 3D + Leaflet + AR</title>
<style>
html, body { margin:0; height:100%; overflow:hidden; background:#000; }
#earth3d { position:absolute; top:0; left:0; width:100%; height:100%; }
#map { position:absolute; top:10px; left:10px; width:500px; height:300px; z-index:100; border:2px solid #fff; border-radius:6px; }
#info { position: absolute; left:10px; top:10px; color:#000; font-family:sans-serif; z-index:200; }
#cameraFeed { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:-1; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.180.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.180.0/examples/jsm/"
  }
}
</script>
</head>

<body>
<video id="cameraFeed" autoplay muted playsinline></video>
<div id="info">TD3 — Terre 3D + Leaflet + AR</div>
<div id="earth3d"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

const container3D = document.getElementById('earth3d');
const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera(60, container3D.clientWidth/container3D.clientHeight, 0.1, 1000);
camera.position.set(0, 0, 3);

const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
renderer.setSize(container3D.clientWidth, container3D.clientHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
container3D.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff,0.6));
const dir = new THREE.DirectionalLight(0xffffff,1);
dir.position.set(5,3,5);
scene.add(dir);

const texLoader = new THREE.TextureLoader();
const earthTexture = texLoader.load('https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg');
const earth = new THREE.Mesh(
  new THREE.SphereGeometry(1,64,64),
  new THREE.MeshPhongMaterial({ map: earthTexture })
);
const earthGroup = new THREE.Group();
earthGroup.add(earth);
scene.add(earthGroup);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

function latLonToVector3(lat, lon, radius=1){
  const phi = (90-lat)*(Math.PI/180);
  const theta = (lon+180)*(Math.PI/180);
  const x = -radius*Math.sin(phi)*Math.cos(theta);
  const z = radius*Math.sin(phi)*Math.sin(theta);
  const y = radius*Math.cos(phi);
  return new THREE.Vector3(x,y,z);
}

function createMarker(color=0xff0000, size=0.02){
  return new THREE.Mesh(
    new THREE.SphereGeometry(size,16,16),
    new THREE.MeshBasicMaterial({color})
  );
}

async function addCountryFlags(){
  const res = await fetch('https://restcountries.com/v3.1/all?fields=name,flags,latlng');
  const countries = await res.json();
  const subset = countries.slice(0,50);
  subset.forEach(c=>{
    if(!c.latlng || !c.flags || !c.flags.png) return;
    const [lat,lon] = c.latlng;
    const pos = latLonToVector3(lat,lon,1.03);
    const flagTex = texLoader.load(c.flags.png);
    const plane = new THREE.Mesh(
      new THREE.PlaneGeometry(0.05,0.03),
      new THREE.MeshBasicMaterial({ map: flagTex, transparent:true, side: THREE.FrontSide })
    );
    plane.position.copy(pos);
    plane.lookAt(pos.clone().multiplyScalar(2));
    earthGroup.add(plane);
    plane.userData = { lat, lon, name: c.name.common };
  });
}
addCountryFlags();

const video = document.getElementById('cameraFeed');
navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false })
.then(stream => { video.srcObject = stream; })
.catch(err => console.error("Erreur accès caméra :", err));

const arMarker = createMarker(0x00ff00, 0.05);
scene.add(arMarker);

window.addEventListener('deviceorientation', e=>{

  const alpha = THREE.MathUtils.degToRad(e.alpha||0);
  const beta = THREE.MathUtils.degToRad(e.beta||0);
  const gamma = THREE.MathUtils.degToRad(e.gamma||0);

  const radius = 1.5;
  const x = radius * Math.sin(alpha) * Math.cos(beta);
  const y = radius * Math.sin(beta);
  const z = -radius * Math.cos(alpha) * Math.cos(beta);
  arMarker.position.set(x, y, z);
});

function animate(){
  controls.update();
  renderer.render(scene,camera);
  requestAnimationFrame(animate);
}
animate();

window.addEventListener('resize', ()=>{
  camera.aspect = container3D.clientWidth/container3D.clientHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(container3D.clientWidth, container3D.clientHeight);
});

const map = L.map('map', { zoomControl:false }).setView([0,0],2);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap' }).addTo(map);

map.on('click', e=>{
  const {lat, lng} = e.latlng;
  const target = latLonToVector3(lat,lng,1);
  earthGroup.rotation.set(0,0,0);
  const theta = Math.atan2(target.x,target.z);
  const phi = Math.asin(target.y/target.length());
  earthGroup.rotation.y = -theta;
  earthGroup.rotation.x = phi;

  if(window.leafletClickMarker) map.removeLayer(window.leafletClickMarker);
  window.leafletClickMarker = L.marker([lat,lng]).addTo(map);
});
</script>
</body>
</html>
